name: Daily Rank Check

on:
  schedule:
    - cron: '0 5 * * *'  # 매일 KST 14:00 (UTC 05:00)
  workflow_dispatch:      # 수동 실행 버튼도 활성화

jobs:
  check-rank:
    runs-on: ubuntu-latest

    steps:
      - name: Run daily rank check
        run: |
          BASE_URL="https://marketinginside.pages.dev"

          # 1. 로그인 → 토큰 발급
          echo "=== 로그인 중 ==="
          TOKEN=$(curl -sf -X POST "$BASE_URL/api/auth" \
            -H "Content-Type: application/json" \
            -d "{\"password\":\"$ADMIN_PASSWORD\"}" | jq -r '.token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "로그인 실패"
            exit 1
          fi
          echo "로그인 성공"

          # 2. 매장 목록 조회
          echo "=== 매장 목록 조회 중 ==="
          PLACES=$(curl -sf "$BASE_URL/api/places" \
            -H "X-Admin-Token: $TOKEN")

          PLACE_COUNT=$(echo "$PLACES" | jq 'length')
          echo "매장 수: $PLACE_COUNT"

          if [ "$PLACE_COUNT" = "0" ]; then
            echo "등록된 매장이 없습니다."
            exit 0
          fi

          # 3. 매장별 순위 체크
          echo "=== 순위 체크 시작 ==="
          echo "$PLACES" | jq -c '.[]' | while IFS= read -r place; do
            NAME=$(echo "$place" | jq -r '.name')
            PLACE_ID=$(echo "$place" | jq -r '.id')
            NAVER_ID=$(echo "$place" | jq -r '.naver_place_id')
            KEYWORDS=$(echo "$place" | jq '.keywords')

            echo "▶ $NAME"
            RESULT=$(curl -sf -X POST "$BASE_URL/api/check-rank" \
              -H "Content-Type: application/json" \
              -H "X-Admin-Token: $TOKEN" \
              -d "{\"place_id\":\"$PLACE_ID\",\"naver_place_id\":\"$NAVER_ID\",\"keywords\":$KEYWORDS}")

            echo "$RESULT" | jq -r '.results[] | "  \(.keyword): \(if .rank then "\(.rank)위" else "300위 밖" end)"' 2>/dev/null || echo "  결과 파싱 오류"

            sleep 3
          done

          echo "=== 완료 ==="
        env:
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
